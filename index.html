<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SlopeLedger — Ski Instructor Ledger</title>

  <!-- Tailwind (quick CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- React + ReactDOM UMD for quick no-build setup -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel standalone to allow JSX inline -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">

  <div id="root" class="min-h-screen p-6"></div>

  <!-- App code -->
  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  function formatCurrency(v){ return Number(v||0).toFixed(2); }

  function SlopeLedgerApp(){
    // main lists
    const [incomeEntries, setIncomeEntries] = useState([]);
    const [expenseEntries, setExpenseEntries] = useState([]);
    const [workLog, setWorkLog] = useState([]);

    // forms
    const [incomeForm, setIncomeForm] = useState({date:'', hours:'', rate:'', workplace:'', source:''});
    const [expenseForm, setExpenseForm] = useState({date:'', amount:'', category:'', description:'', receiptFile:null});
    const [workForm, setWorkForm] = useState({date:'', hours:'', rate:'', workplace:''});

    // sync endpoint (Apps Script Web App URL)
    const [sheetEndpoint, setSheetEndpoint] = useState(localStorage.getItem('slopeledger_endpoint') || '');

    // status
    const [statusMessage, setStatusMessage] = useState('');

    useEffect(()=>{ // load saved data
      const saved = JSON.parse(localStorage.getItem('slopeledger_v1') || '{}');
      if(saved.incomeEntries) setIncomeEntries(saved.incomeEntries);
      if(saved.expenseEntries) setExpenseEntries(saved.expenseEntries);
      if(saved.workLog) setWorkLog(saved.workLog);
      if(saved.sheetEndpoint) setSheetEndpoint(saved.sheetEndpoint);
    }, []);

    useEffect(()=>{ // persist
      localStorage.setItem('slopeledger_v1', JSON.stringify({incomeEntries,expenseEntries,workLog, sheetEndpoint}));
    }, [incomeEntries,expenseEntries,workLog,sheetEndpoint]);

    // summaries
    const totalIncome = incomeEntries.reduce((s,e)=> s + Number(e.amount || (Number(e.hours||0)*Number(e.rate||0)) || 0), 0);
    const totalExpenses = expenseEntries.reduce((s,e)=> s + Number(e.amount||0), 0);
    const totalHours = workLog.reduce((s,w)=> s + Number(w.hours||0), 0);
    const avgRate = totalHours ? (workLog.reduce((s,w)=> s + (Number(w.hours||0)*Number(w.rate||0)),0) / totalHours) : 0;
    const net = totalIncome - totalExpenses;

    function idNow(){ return Date.now() + '_' + Math.random().toString(36).slice(2,7); }

    // Send generic payload to Apps Script
    async function sendToSheet(payload){
      if(!sheetEndpoint) {
        setStatusMessage('No Apps Script endpoint set — offline only.');
        return;
      }
      try{
        const res = await fetch(sheetEndpoint, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({action:'append', payload})
        });
        const j = await res.json();
        setStatusMessage('Sync: ' + (j.status || JSON.stringify(j)));
      }catch(err){
        console.error(err);
        setStatusMessage('Sync failed: ' + err.message);
      }
    }

    // Upload receipt by base64 to Apps Script
    async function uploadReceiptBase64(file, entryId){
      if(!sheetEndpoint) throw new Error('Apps Script endpoint not set.');
      // read file as dataURL
      const dataUrl = await new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
      const payload = { action: 'upload_receipt_base64', entryId, filename: file.name, contentType: file.type, dataUrl };
      const res = await fetch(sheetEndpoint, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await res.json();
      if(j.status !== 'ok') throw new Error(j.message || 'upload failed');
      return j; // should include {status:'ok', url: 'https://...'}
    }

    // Handlers
    async function addIncome(e){
      e && e.preventDefault();
      const hours = Number(incomeForm.hours || 0);
      const rate = Number(incomeForm.rate || 0);
      const amount = hours ? hours * rate : 0;
      const entry = { id: idNow(), date: incomeForm.date || new Date().toISOString().slice(0,10), hours, rate, workplace: incomeForm.workplace || '', source: incomeForm.source || '', amount };
      const next = [...incomeEntries, entry];
      setIncomeEntries(next);
      setIncomeForm({date:'', hours:'', rate:'', workplace:'', source:''});
      sendToSheet({type:'income', entry});
    }

    async function addExpense(e){
      e && e.preventDefault();
      const amount = Number(expenseForm.amount || 0);
      const entry = { id: idNow(), date: expenseForm.date || new Date().toISOString().slice(0,10), amount, category: expenseForm.category || '', description: expenseForm.description || '', receiptUrl: null };
      let next = [...expenseEntries, entry];
      setExpenseEntries(next);

      if(expenseForm.receiptFile){
        try{
          setStatusMessage('Uploading receipt...');
          const result = await uploadReceiptBase64(expenseForm.receiptFile, entry.id);
          entry.receiptUrl = result.url;
          next = next.map(x => x.id === entry.id ? entry : x);
          setExpenseEntries(next);
          // tell sheets about the uploaded URL
          sendToSheet({type:'expense', entry});
        }catch(err){
          console.error(err);
          setStatusMessage('Receipt upload failed: ' + err.message);
        }
      } else {
        sendToSheet({type:'expense', entry});
      }

      setExpenseForm({date:'', amount:'', category:'', description:'', receiptFile:null});
    }

    async function addWork(e){
      e && e.preventDefault();
      const hours = Number(workForm.hours || 0);
      const rate = Number(workForm.rate || 0);
      const entry = { id: idNow(), date: workForm.date || new Date().toISOString().slice(0,10), hours, rate, workplace: workForm.workplace || '' };
      const next = [...workLog, entry];
      setWorkLog(next);
      setWorkForm({date:'', hours:'', rate:'', workplace:''});
      sendToSheet({type:'work', entry});
    }

    // Monzo CSV import: parse CSV text and map columns
    async function importMonzoCsvText(csvText){
      // basic CSV split (handles simple CSVs — Monzo exports are simple)
      const lines = csvText.trim().split('\\n').map(l => l.trim());
      if(lines.length < 2) { setStatusMessage('CSV looks empty'); return; }
      const headers = lines[0].split(',').map(h=>h.replace(/\"/g,'').trim());
      const rows = lines.slice(1).map(r => {
        // naive split on comma, preserve quoted fields
        const values = r.match(/(".*?"|[^",]+)(?=,|$)/g).map(v => v.replace(/^"|"$/g,''));
        const obj = {};
        headers.forEach((h,i)=> obj[h]=values[i] || '');
        return obj;
      });

      // Map rows to expenses/income depending on amount sign
      let added = 0;
      for(const r of rows){
        // Monzo CSV usually has "Amount" or "Amount(£)" column — try a few names
        const amountRaw = r['Amount'] ?? r['Amount (GBP)'] ?? r['Amount (\\u00A3)'] ?? r['Amount (GBP)'] ?? r['Value'] ?? Object.values(r).find(v=>/^-?\\d+\\.\\d{2}$/.test(v)) ?? '0';
        const amount = Number(amountRaw.replace(/[^0-9-.]/g,'') || 0);
        const date = r['Date'] || r['Created'] || r['Timestamp'] || new Date().toISOString().slice(0,10);
        const description = r['Description'] || r['Merchant'] || r['Category'] || '';
        if(amount === 0) continue;
        if(amount < 0){
          // expense
          const entry = { id: idNow(), date, amount: Math.abs(amount), category: 'Monzo import', description };
          setExpenseEntries(prev => { sendToSheet({type:'expense', entry}); return [...prev, entry]; });
          added++;
        } else {
          // income
          const entry = { id: idNow(), date, amount, hours: '', rate:'', workplace:'Monzo import', source: description };
          setIncomeEntries(prev => { sendToSheet({type:'income', entry}); return [...prev, entry]; });
          added++;
        }
      }
      setStatusMessage('Imported ' + added + ' rows from CSV.');
    }

    // helper to handle CSV file from input
    function handleMonzoCsvFile(file){
      const r = new FileReader();
      r.onload = e => importMonzoCsvText(e.target.result);
      r.readAsText(file);
    }

    return (
      <div className="max-w-5xl mx-auto">
        <header className="mb-4">
          <h1 className="text-3xl font-bold">SlopeLedger</h1>
          <p className="text-sm text-slate-600">Simple bookkeeping and shift tracker for self-employed ski instructors.</p>
        </header>

        <main className="grid md:grid-cols-2 gap-6">
          <section className="bg-white p-4 rounded-2xl shadow">
            <h2 className="font-semibold">Log Income</h2>
            <form className="mt-3 space-y-2" onSubmit={addIncome}>
              <div className="grid grid-cols-2 gap-2">
                <input type="date" value={incomeForm.date} onChange={e=>setIncomeForm({...incomeForm,date:e.target.value})} className="p-2 border rounded"/>
                <input placeholder="Workplace (resort)" value={incomeForm.workplace} onChange={e=>setIncomeForm({...incomeForm,workplace:e.target.value})} className="p-2 border rounded"/>
              </div>
              <div className="grid grid-cols-3 gap-2">
                <input type="number" step="0.1" placeholder="Hours" value={incomeForm.hours} onChange={e=>setIncomeForm({...incomeForm,hours:e.target.value})} className="p-2 border rounded"/>
                <input type="number" step="0.01" placeholder="Rate (£/hr)" value={incomeForm.rate} onChange={e=>setIncomeForm({...incomeForm,rate:e.target.value})} className="p-2 border rounded"/>
                <input placeholder="Source (private/group)" value={incomeForm.source} onChange={e=>setIncomeForm({...incomeForm,source:e.target.value})} className="p-2 border rounded"/>
              </div>
              <div className="flex gap-2">
                <button className="px-4 py-2 rounded bg-emerald-600 text-white">Add Income</button>
                <button type="button" onClick={()=>{ navigator.clipboard.writeText(JSON.stringify({incomeEntries,expenseEntries,workLog})); alert('Exported JSON to clipboard'); }} className="px-4 py-2 rounded border">Export JSON</button>
              </div>
            </form>

            <hr className="my-3"/>
            <h3 className="font-medium">Work / Shift Log</h3>
            <form className="mt-2 space-y-2" onSubmit={addWork}>
              <div className="grid grid-cols-2 gap-2">
                <input type="date" value={workForm.date} onChange={e=>setWorkForm({...workForm,date:e.target.value})} className="p-2 border rounded"/>
                <input placeholder="Workplace" value={workForm.workplace} onChange={e=>setWorkForm({...workForm,workplace:e.target.value})} className="p-2 border rounded"/>
              </div>
              <div className="grid grid-cols-2 gap-2">
                <input step="0.1" type="number" placeholder="Hours" value={workForm.hours} onChange={e=>setWorkForm({...workForm,hours:e.target.value})} className="p-2 border rounded"/>
                <input step="0.01" type="number" placeholder="Rate" value={workForm.rate} onChange={e=>setWorkForm({...workForm,rate:e.target.value})} className="p-2 border rounded"/>
              </div>
              <button className="px-4 py-2 rounded bg-amber-500 text-white">Add Shift</button>
            </form>
          </section>

          <section className="bg-white p-4 rounded-2xl shadow">
            <h2 className="font-semibold">Expenses</h2>
            <form className="mt-3 space-y-2" onSubmit={addExpense}>
              <div className="grid grid-cols-2 gap-2">
                <input type="date" value={expenseForm.date} onChange={e=>setExpenseForm({...expenseForm,date:e.target.value})} className="p-2 border rounded"/>
                <input type="number" step="0.01" placeholder="Amount (£)" value={expenseForm.amount} onChange={e=>setExpenseForm({...expenseForm,amount:e.target.value})} className="p-2 border rounded"/>
              </div>
              <input placeholder="Category (travel, kit, admin)" value={expenseForm.category} onChange={e=>setExpenseForm({...expenseForm,category:e.target.value})} className="p-2 border rounded"/>
              <textarea placeholder="Description" value={expenseForm.description} onChange={e=>setExpenseForm({...expenseForm,description:e.target.value})} className="p-2 border rounded"/>
              <div>
                <input type="file" accept="image/*,application/pdf" onChange={e=>setExpenseForm({...expenseForm,receiptFile: e.target.files[0]})} />
                <p className="text-xs text-slate-500">Attach photo/PDF receipt.</p>
              </div>
              <div className="flex gap-2">
                <button className="px-4 py-2 rounded bg-red-600 text-white">Add Expense</button>
                <button type="button" onClick={() => {
                  // quick CSV export
                  const csvRows = [
                    ['type','date','amount','category','desc','workplace','hours','rate','receiptUrl'],
                    ...incomeEntries.map(i=>['income',i.date,i.amount,'',i.source,i.workplace,i.hours,i.rate,'']),
                    ...expenseEntries.map(x=>['expense',x.date,x.amount,x.category,x.description,'','','',x.receiptUrl || '']),
                    ...workLog.map(w=>['work',w.date,'', '', '', w.workplace, w.hours, w.rate, ''])
                  ];
                  const csv = csvRows.map(r=> r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\\n');
                  const blob = new Blob([csv], {type:'text/csv'});
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a'); a.href = url; a.download = 'slopeledger_export.csv'; a.click(); URL.revokeObjectURL(url);
                }} className="px-4 py-2 rounded border">Export CSV</button>
              </div>
            </form>

            <hr className="my-3"/>
            <h3 className="font-medium">Quick summaries</h3>
            <ul className="mt-2 space-y-1 text-sm text-slate-700">
              <li>Total Income: £{formatCurrency(totalIncome)}</li>
              <li>Total Expenses: £{formatCurrency(totalExpenses)}</li>
              <li>Net: £{formatCurrency(net)}</li>
              <li>Total Hours: {Number(totalHours).toFixed(1)}</li>
              <li>Avg Hourly Rate: £{formatCurrency(avgRate)}</li>
            </ul>
          </section>

          <section className="col-span-2 bg-white p-4 rounded-2xl shadow">
            <h2 className="font-semibold">Sync & Data</h2>
            <p className="text-sm text-slate-600">Paste the Google Apps Script Web App URL (see README steps below) to enable automatic syncing to Google Sheets and receipt uploads to Drive.</p>

            <div className="mt-3 grid grid-cols-3 gap-2">
              <input value={sheetEndpoint} onChange={e=>setSheetEndpoint(e.target.value)} placeholder="Apps Script Web App URL" className="p-2 border rounded col-span-2"/>
              <button onClick={()=>{ localStorage.setItem('slopeledger_endpoint', sheetEndpoint); setStatusMessage('Endpoint saved locally'); }} className="px-4 py-2 rounded bg-indigo-600 text-white">Save</button>
            </div>

            <div className="mt-3">
              <strong>Status:</strong> <span className="ml-2 text-slate-700">{statusMessage || 'Not synced'}</span>
            </div>

            <hr className="my-3" />
            <h3 className="font-medium">Import Monzo CSV</h3>
            <p className="text-sm text-slate-600">Export CSV from Monzo app, then upload it here to import transactions as income/expenses.</p>
            <div className="flex gap-2 items-center mt-2">
              <input type="file" accept=".csv,text/csv" onChange={e=> { if(e.target.files[0]) handleMonzoCsvFile(e.target.files[0]); }} />
              <button className="px-3 py-2 rounded border" onClick={()=> alert('Monzo OAuth is not implemented; use CSV export from the Monzo app (Settings → Export)')}>How to export</button>
            </div>

            <hr className="my-3" />
            <h3 className="font-medium">Recent</h3>
            <div className="grid md:grid-cols-3 gap-3 mt-2">
              <ListCard title="Income" items={incomeEntries.slice().reverse().slice(0,6)} />
              <ListCard title="Expenses" items={expenseEntries.slice().reverse().slice(0,6)} />
              <ListCard title="Shifts" items={workLog.slice().reverse().slice(0,6)} />
            </div>
          </section>
        </main>

        <footer className="mt-6 text-xs text-slate-500">Host on GitHub Pages — see the README instructions included in the project.</footer>
      </div>
    );
  }

  function ListCard({title, items}){
    return (
      <div className="p-3 border rounded">
        <h4 className="font-medium">{title}</h4>
        <ul className="mt-2 text-sm max-h-52 overflow-auto">
          {items.length === 0 ? <li className="text-slate-400">No entries yet</li> :
            items.map(it => (
              <li key={it.id} className="py-1 border-b last:border-b-0">
                <div className="flex justify-between"><span>{it.date}</span><span>£{formatCurrency(it.amount || (it.hours * it.rate) || 0)}</span></div>
                <div className="text-xs text-slate-500">{it.workplace || it.category || it.description || ''}</div>
              </li>
            ))
          }
        </ul>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<SlopeLedgerApp />);
  </script>
</body>
</html>
